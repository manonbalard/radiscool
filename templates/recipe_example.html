<html>
<body>
  {% extends "layout.html" %}
  {% block content %}
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <form class="row g-3" action="{{ url_for('addrecipe') }}" method="POST">
    <h3>Créez votre recette ci-dessous:</h3>
    <br>
    <br>
    <input type="hidden" name="recette_id" value="{{ recette_id }}">
    <div class="container">
      <div class="row">
        <div class="col-md-4">
          <label for="titre" class="form-label">Titre de la recette:</label><br>
        </div>
        <div class="col-md-4">
          <input type="text" aria-label="titre" class="form-control" name="titre" required><br>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4">
          <label for="typedeplat" class="form-label">Type de plat:</label><br>
        </div>
        <div class="col-md-4">
          <select class="form-select" aria-label="Default select example">
            <option selected>Ouvrez le menu déroulant</option>
            <option value="Entrée">Entrée</option>
            <option value="Plat">Plat</option>
            <option value="Dessert">Dessert</option>
          </select>
        </div>
      </div>
    </div>
    <br>
    <h4>Ingrédients de la recette:</h4><br>
    <div class="row">
      <div class="col">
        <input type="text" class="form-control" name="quantité" placeholder="Quantité (exemple 1, 10...)">
      </div>
      <div class="col">
        <input type="text" class="form-control" name="unité" placeholder="Unité (exemple kg, cl...)">
      </div>
      <div class="col">
        <input type="text" class="form-control" name="ingrédient" placeholder='Ingrédient (exemple "Tomate")'>
      </div>
      <div class="col">
        <button type="submit" formaction="{{ url_for('addingredient') }}" class="btn btn-secondary" id="add-ingredient-button">Ajouter ingrédient</button>
      </div>
    </div>
    <div id="section-view-ingredients">
      <script>
        $(document).ready(function(){
          function refreshIngredients() {
            $.getJSON('/viewingredients', function(data_ingredients_list) {
              var content = '<table class="table"><thead><tr><th scope="col">Quantité</th><th scope="col">Unité</th><th scope="col">Ingrédient</th></tr></thead><tbody>';
              $.each(data_ingredients_list, function(index, ingredient){
                content += '<tr><td>' + ingredient.quantité + '</td><td>' + ingredient.unité + '</td><td>' + ingredient.ingrédient + '</td></tr>';
              });
              content += '</tbody></table>';
              $('#section-view-ingredients').html(content);
            });
          }
          $('#add-ingredient-button').click(function(event){
            event.preventDefault(); 
            var quantité = $('input[name="quantité"]').val();
            var unité = $('input[name="unité"]').val();
            var ingrédient = $('input[name="ingrédient"]').val();
            $.post('/addingredient', {
              quantité: quantité,
              unité: unité,
              ingrédient: ingrédient
            }, function(response) {
              refreshIngredients();
              $('input[name="quantité"]').val('');
              $('input[name="unité"]').val('');
              $('input[name="ingrédient"]').val('');
            });
          });
        });
      </script>
    </div>
    <h4>Etapes:</h4><br>
    <div class="row">
      <div class="col">
        <input type="text" id= "stepInput" class="form-control" name="step_text" placeholder="Description de l'étape: (exemple 'Mélanger les ingrédients')">
      </div>
      <div class="col">
        <button type="submit" formaction="{{ url_for('addstep') }}" class="btn btn-secondary" id="addStep">Ajouter l'étape</button>
        <ul id="stepsList"></ul>
      </div>
    </div>
    <div id="section-view-steps">
      <script>
      $(document).ready(function() {
        function fetchAndDisplaySteps() {
          $.getJSON('/viewsteps', function(data_steps_list) {
            $('#stepsList').empty();
            $.each(data_steps_list, function(index, step) {
                $('#stepsList').append(`<li id="step-${step.id}" class="ui-state-default">
                                            <span class="step-text">${step.step_text}</span>
                                            <button onclick="editStep(${step.id})">Edit</button>
                                        </li>`);
                              });
        });
    }

    fetchAndDisplaySteps();
          let stepCount = 0;
    
          $('#addStep').click(function() {
            const stepText = $('#stepInput').val();
            if (stepText) {
              stepCount++;
              $('#stepsList').append(`<li id="step-${stepCount}" class="ui-state-default">
                                        <span class="step-text">${stepText}</span>
                                        <button onclick="editStep(${stepCount})">Edit</button>
                                      </li>`);
              $('#stepInput').val('');
            }
          });
    
          $('#stepsList').sortable();
            });
      </script>

    <input type="submit" value="Submit" /><br>
  </form>
  {% endblock %}
</body>
</html>
